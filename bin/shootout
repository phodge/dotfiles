#!/usr/bin/env python3
import csv
import sys
from collections import defaultdict

datayear = 2019

if datayear == 2019:
    headings = dict(
        have='LanguageWorkedWith',
        want='LanguageDesireNextYear',
    )
else:
    headings = dict(
        have='HaveWorkedLanguage',
        want='WantWorkLanguage',
    )

# groovy, haskell, elixir
T = sys.argv[1]
lang1 = sys.argv[2]
lang2 = sys.argv[3]

lang1lower = lang1.lower()
lang2lower = lang2.lower()


numlang1 = 0
numcontinuelang1 = 0
numlang2 = 0
numcontinuelang2 = 0
numboth = 0
numpreferlang2 = 0
numpreferlang1 = 0
numnopref = 0
# is there another language the person has used and wants to continue using, in
# favour of lang1 and lang2?
trump = defaultdict(lambda: 0)

total = 0
with open(T) as f:
    reader = csv.reader(f)
    first = None
    for row in reader:
        total += 1
        if ((total % 1000) == 0):
            print('.', end='', flush=True)

        if first is None:
            first = row
            haveidx = row.index(headings['have'])
            wantidx = row.index(headings['want'])
            continue

        have = {l.lower().strip() for l in row[haveidx].split(';')}
        want = {l.lower().strip() for l in row[wantidx].split(';')}

        check = 0

        wantlang1 = lang1lower in want
        wantlang2 = lang2lower in want

        if lang2lower in have:
            check += 1
            numlang2 += 1
            if wantlang2:
                numcontinuelang2 += 1

        if lang1lower in have:
            check += 1
            numlang1 += 1
            if wantlang1:
                numcontinuelang1 += 1

        if check > 1:
            numboth += 1

            if wantlang1:
                if wantlang2:
                    numnopref += 1
                else:
                    numpreferlang1 += 1
            elif wantlang2:
                numpreferlang2 += 1
            else:
                for wanted in want:
                    if wanted in have:
                        trump[wanted] += 1

# how many users don't want to use either any more?
numstop = numboth - numpreferlang1 - numpreferlang2 - numnopref

pccontinuelang1 = (100 * (float(numcontinuelang1) / float(numlang1))) if numlang1 else 0
pccontinuelang2 = (100 * (float(numcontinuelang2) / float(numlang2))) if numlang2 else 0


print('')
print(f'Of {total} responses:')
print(f'  {numlang1} have used {lang1}; {numcontinuelang1} ({pccontinuelang1:.1f}%) wish to continue using it')
print(f'  {numlang2} have used {lang2}; {numcontinuelang2} ({pccontinuelang2:.1f}%) wish to continue using it')
print(f'  {numboth} have used both')
print(f'Of {numboth} respondends that have used both:')
print(f'  {numpreferlang2} want to continue using {lang2}, but not {lang1}')
print(f'  {numpreferlang1} want to continue using {lang1}, but not {lang2}')
print(f'  {numnopref} want to continue using both')
print(f"  {numstop} don't want to continue using either")

# ignore 'SQL' as an alternative language
trump.pop('sql', None)

trumpitems = [(k, v) for k, v in trump.items() if v > 10]

trumpitems.sort(key=lambda i: i[1], reverse=True)

if len(trumpitems):
    print(f'  Popular alternatives:')
    for other, numother in trumpitems:
        print(f'    {numother} have also used {other} and want to use it instead')
